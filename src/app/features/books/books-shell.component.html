<section class="books-root">
  <header class="header">
    <div class="header-content">
      <div>
        <h1 class="page-title">Book Management</h1>
        <p class="subtitle">
          Add, edit, and manage books in the library collection
        </p>
      </div>
      <button type="button" class="btn btn-primary" (click)="openCreateDialog()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span>Add Book</span>
      </button>
    </div>
  </header>

  <div class="toolbar">
    <div class="search-wrapper">
      <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input
        type="search"
        placeholder="Search by title, author, or category..."
        (input)="onSearch($any($event.target).value)"
        class="search-input"
      />
    </div>

    <select
      (change)="onStatusFilterChange($any($event.target).value)"
      aria-label="Filter by availability"
      class="filter-select"
    >
      <option value="all">All statuses</option>
      <option value="available">Available</option>
      <option value="unavailable">Unavailable</option>
    </select>
  </div>

  <div class="table-container">
    <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Author</th>
          <th>Category</th>
          <th>ISBN</th>
          <th>Available</th>
          <th>Status</th>
          <th class="actions-col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngIf="books$ | async as books">
          <tr
            *ngFor="let book of books
              | slice: 0:books.length
              | filterBooks: searchTerm():statusFilter()"
            class="table-row"
          >
            <td class="table-cell-title">
              <div class="book-title-wrapper">
                <span class="book-icon">üìö</span>
                <span>{{ book.title }}</span>
              </div>
            </td>
            <td>{{ book.author }}</td>
            <td>
              <span class="category-badge">{{ book.category }}</span>
            </td>
            <td class="isbn-cell">{{ book.isbn }}</td>
            <td>
              <span class="availability-badge">
                <span class="available-count">{{ book.quantityAvailable }}</span>
                <span class="separator">/</span>
                <span class="total-count">{{ book.quantityTotal }}</span>
              </span>
            </td>
            <td>
              <span
                class="status-badge"
                [class.status-available]="book.status === 'available'"
                [class.status-unavailable]="book.status === 'unavailable'"
              >
                {{ book.status | titlecase }}
              </span>
            </td>
            <td class="actions-col">
              <div class="action-buttons">
                <button
                  type="button"
                  class="btn-action btn-edit"
                  (click)="openEditDialog(book)"
                  title="Edit book"
                >
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
                <button
                  type="button"
                  class="btn-action btn-qr"
                  (click)="openQrDialog(book)"
                  title="Show QR code"
                >
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="5" height="5"></rect>
                    <rect x="16" y="3" width="5" height="5"></rect>
                    <rect x="3" y="16" width="5" height="5"></rect>
                    <path d="M21 16h-3a2 2 0 0 0-2 2v3"></path>
                    <path d="M21 21v.01"></path>
                    <path d="M12 7v3a2 2 0 0 1-2 2H7"></path>
                    <path d="M21 12v.01"></path>
                    <path d="M12 21h.01"></path>
                  </svg>
                </button>
                <button
                  type="button"
                  class="btn-action btn-delete"
                  (click)="delete(book)"
                  title="Delete book"
                >
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>

          <tr *ngIf="books.length === 0">
            <td colspan="7" class="empty-state">
              No books found. Click ‚ÄúAdd book‚Äù to create one.
            </td>
          </tr>
        </ng-container>
      </tbody>
      </table>
    </div>
  </div>

  <!-- Dialog -->
  <div class="dialog-backdrop" *ngIf="isDialogOpen()" (click)="closeDialog()">
    <div class="dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h3>{{ editingBook() ? 'Edit Book' : 'Add New Book' }}</h3>
        <button type="button" class="btn-close" (click)="closeDialog()" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <form [formGroup]="form" (ngSubmit)="save()" class="form-grid">
        <label class="form-field">
          <span class="form-label">Title <span class="required">*</span></span>
          <input type="text" formControlName="title" class="form-input" placeholder="Enter book title" />
        </label>

        <label class="form-field">
          <span class="form-label">Author <span class="required">*</span></span>
          <input type="text" formControlName="author" class="form-input" placeholder="Enter author name" />
        </label>

        <label class="form-field">
          <span class="form-label">Category <span class="required">*</span></span>
          <input type="text" formControlName="category" class="form-input" placeholder="e.g., Fiction, Science" />
        </label>

        <label class="form-field">
          <span class="form-label">ISBN <span class="required">*</span></span>
          <input type="text" formControlName="isbn" class="form-input" placeholder="Enter ISBN number" />
        </label>

        <label class="form-field">
          <span class="form-label">Total Quantity <span class="required">*</span></span>
          <input type="number" formControlName="quantityTotal" class="form-input" min="0" />
        </label>

        <label class="form-field">
          <span class="form-label">Available <span class="required">*</span></span>
          <input type="number" formControlName="quantityAvailable" class="form-input" min="0" />
        </label>

        <label class="form-field">
          <span class="form-label">Status <span class="required">*</span></span>
          <select formControlName="status" class="form-select">
            <option value="available">Available</option>
            <option value="unavailable">Unavailable</option>
          </select>
        </label>

        <label class="form-field full-width">
          <span class="form-label">Description</span>
          <textarea formControlName="description" rows="4" class="form-textarea" placeholder="Enter book description (optional)"></textarea>
        </label>

        <div class="dialog-actions full-width">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeDialog()"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- QR dialog -->
  <div class="dialog-backdrop" *ngIf="qrBook()" (click)="closeQrDialog()">
    <div class="dialog dialog--qr" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h3>Book QR Code</h3>
        <button type="button" class="btn-close" (click)="closeQrDialog()" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <p class="dialog-subtitle">
        Scan this QR code to borrow or return this book quickly
      </p>

      <div class="qr-preview" *ngIf="qrBook() as b">
        <div class="qr-code-wrapper">
          <app-qr-code
            [value]="b.id || b.isbn"
            [size]="240"
          ></app-qr-code>
        </div>
        <div class="qr-meta">
          <div class="qr-title">{{ b.title }}</div>
          <div class="qr-author">{{ b.author }}</div>
          <div class="qr-id">
            <span class="qr-id-label">Encoded ID:</span>
            <span class="qr-id-value">{{ b.id || b.isbn }}</span>
          </div>
        </div>
      </div>

      <div class="dialog-actions full-width">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeQrDialog()"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</section>

